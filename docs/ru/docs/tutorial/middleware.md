# Middleware (–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û)

–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π (middleware) –≤ **FastAPI** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

"Middleware" —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º **–∑–∞–ø—Ä–æ—Å–æ–º** –¥–æ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*. –ê —Ç–∞–∫–∂–µ —Å –∫–∞–∂–¥—ã–º **–æ—Ç–≤–µ—Ç–æ–º** –ø–µ—Ä–µ–¥ –µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º.

* –û–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π **–∑–∞–ø—Ä–æ—Å**, –ø–æ—Å—Ç—É–ø–∞—é—â–∏–π –≤ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
* –ú–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º **–∑–∞–ø—Ä–æ—Å–æ–º** –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–¥.
* –ó–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç **–∑–∞–ø—Ä–æ—Å** –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–∫–∞–∫–æ–π-–ª–∏–±–æ *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*).
* –ó–∞—Ç–µ–º –æ–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–æ—Ç–≤–µ—Ç**, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–∫–∞–∫–æ–π-–ª–∏–±–æ *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*).
* –ú–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º **–æ—Ç–≤–µ—Ç–æ–º** –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–¥.
* –ó–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ—Ç–≤–µ—Ç**.

/// note | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å `yield`, –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è *–ø–æ—Å–ª–µ* –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û.

–ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (—Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–µ –≤ —Ä–∞–∑–¥–µ–ª–µ [–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏](background-tasks.md){.internal-link target=_blank}, –≤—ã —É–≤–∏–¥–∏—Ç–µ —ç—Ç–æ –ø–æ–∑–∂–µ), –æ–Ω–∏ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã *–ø–æ—Å–ª–µ* –≤—Å–µ–≥–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û.

///

## –°–æ–∑–¥–∞–Ω–∏–µ middleware

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è middleware –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.middleware("http")` –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π.

–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û –ø–æ–ª—É—á–∞–µ—Ç:

* `request` (–∑–∞–ø—Ä–æ—Å).
* –§—É–Ω–∫—Ü–∏—é `call_next`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∏—Ç `request` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.
    * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–¥–∞—Å—Ç `request` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π *–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É—Ç–∏*.
    * –ó–∞—Ç–µ–º –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∏—Ç `response`, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*.
* –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å `response`, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ.

{* ../../docs_src/middleware/tutorial001.py hl[8:9,11,14] *}

/// tip | –°–æ–≤–µ—Ç

–ò–º–µ–π—Ç–µ –≤ –≤–∏–¥—É, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" class="external-link" target="_blank">—Å –ø–æ–º–æ—â—å—é –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'X-'</a>.

–ù–æ –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CORS ([CORS (Cross-Origin Resource Sharing)](cors.md){.internal-link target=_blank}) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `expose_headers`, –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤ <a href="https://www.starlette.io/middleware/#corsmiddleware" class="external-link" target="_blank">–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ CORS Starlette</a>.

///

/// note | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `from starlette.requests import Request`.

**FastAPI** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤. –ù–æ, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —ç—Ç–æ `Request` –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Starlette.

///

### –î–æ –∏ –ø–æ—Å–ª–µ `response`

–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —Å `request`, –¥–æ —Ç–æ–≥–æ –∫–∞–∫ –∫–∞–∫–∞—è-–ª–∏–±–æ *–æ–ø–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏* –µ–≥–æ –ø–æ–ª—É—á–∏—Ç.

–ê —Ç–∞–∫–∂–µ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `response`, –¥–æ –µ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞.

–ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Process-Time`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:

{* ../../docs_src/middleware/tutorial001.py hl[10,12:13] *}

/// tip | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º <a href="https://docs.python.org/3/library/time.html#time.perf_counter" class="external-link" target="_blank">`time.perf_counter()`</a> –≤–º–µ—Å—Ç–æ `time.time()` –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–∞—à–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤. ü§ì

///

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö middleware

–ö–æ–≥–¥–∞ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ middleware —Å –ø–æ–º–æ—â—å—é –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ `@app.middleware()` –∏–ª–∏ –º–µ—Ç–æ–¥–∞ `app.add_middleware()`, –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ middleware –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ–±—Ä–∞–∑—É—è —Å—Ç–µ–∫. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ middleware –±—É–¥–µ—Ç *–≤–Ω–µ—à–Ω–∏–º*, –∞ –ø–µ—Ä–≤–æ–µ ‚Äî *–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º*.

–ù–∞ —ç—Ç–∞–ø–µ –∑–∞–ø—Ä–æ—Å–∞ —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è *–≤–Ω–µ—à–Ω–µ–µ* middleware.

–ù–∞ —ç—Ç–∞–ø–µ –æ—Ç–≤–µ—Ç–∞ –æ–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º.

–ù–∞–ø—Ä–∏–º–µ—Ä:

```Python
app.add_middleware(MiddlewareA)
app.add_middleware(MiddlewareB)
```

–≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Ä—è–¥–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

* **–ó–∞–ø—Ä–æ—Å**: MiddlewareB ‚Üí MiddlewareA ‚Üí –º–∞—Ä—à—Ä—É—Ç

* **–û—Ç–≤–µ—Ç**: –º–∞—Ä—à—Ä—É—Ç ‚Üí MiddlewareA ‚Üí MiddlewareB

–¢–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Ç–µ–∫–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ middleware –≤ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–º –ø–æ—Ä—è–¥–∫–µ.

## –î—Ä—É–≥–∏–µ middleware

–û –¥—Ä—É–≥–∏—Ö middleware –≤—ã –º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –≤ —Ä–∞–∑–¥–µ–ª–µ [Advanced User Guide: Advanced Middleware](../advanced/middleware.md){.internal-link target=_blank}.

–í —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ –≤—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å <abbr title="Cross-Origin Resource Sharing">CORS</abbr> —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û.
