# Дополнительные ответы в OpenAPI

/// warning | Предупреждение

Это достаточно сложная тема.

Если вы только начинаете работать с **FastAPI**, вам это может не понадобиться.

///

Вы можете объявлять дополнительные ответы с дополнительными статус-кодами, типами содержимого, описаниями и т.д.

Эти дополнительные ответы будут включены в схему OpenAPI, так что они также появятся в документации API.

Но для этих дополнительных ответов вы должны убедиться, что возвращаете `Response`, например, `JSONResponse` напрямую, с вашим статус-кодом и содержимым.

## Дополнительный ответ с `model`

Вы можете передать своим декораторам *операций пути* параметр `responses`.

Он принимает `dict`: ключами являются статус-коды для каждого ответа (например, `200`), а значениями являются другие `dict` с информацией для каждого из них.

Каждый из этих `dict` ответа может содержать ключ `model`, содержащий Pydantic-модель, как и `response_model`.

**FastAPI** возьмет эту модель, сгенерирует ее JSON Schema и включит в нужное место в OpenAPI.

Например, чтобы объявить другой ответ с кодом состояния `404` и Pydantic-моделью `Message`, вы можете написать:

{* ../../docs_src/additional_responses/tutorial001.py hl[18,22] *}

/// note | Заметка

Имейте в виду, что вы должны вернуть `JSONResponse` напрямую.

///

/// info | Информация

Ключ `model` не является частью OpenAPI.

**FastAPI** возьмет Pydantic-модель оттуда, сгенерирует JSON Schema и поместит в нужное место.

Правильное место:

* В ключе `content`, который имеет значение другой JSON объект (`dict`), содержащий:
    * Ключ с типом содержимого, например `application/json`, который в качестве значения содержит другой JSON объект, содержащий:
        * Ключ `schema`, который имеет в качестве значения JSON Schema из модели, вот куда нужно поместить.
            * **FastAPI** добавляет сюда ссылку на глобальные JSON Schemas в другом месте вашего OpenAPI вместо того, чтобы включать его напрямую. Таким образом, другие приложения и клиенты могут использовать эти JSON Schemas напрямую, предоставлять лучшие инструменты генерации кода и другие функции.

///

Сгенерированные ответы в OpenAPI для этой *операции пути* будут:

```JSON hl_lines="3-12"
{
    "responses": {
        "404": {
            "description": "Дополнительный ответ",
            "content": {
                "application/json": {
                    "schema": {
                        "$ref": "#/components/schemas/Message"
                    }
                }
            }
        },
        "200": {
            "description": "Успешный ответ",
            "content": {
                "application/json": {
                    "schema": {
                        "$ref": "#/components/schemas/Item"
                    }
                }
            }
        },
        "422": {
            "description": "Ошибка валидации",
            "content": {
                "application/json": {
                    "schema": {
                        "$ref": "#/components/schemas/HTTPValidationError"
                    }
                }
            }
        }
    }
}
```

Схемы ссылаются на другое место внутри схемы OpenAPI:

```JSON hl_lines="4-16"
{
    "components": {
        "schemas": {
            "Message": {
                "title": "Сообщение",
                "required": [
                    "сообщение"
                ],
                "type": "object",
                "properties": {
                    "сообщение": {
                        "title": "Сообщение",
                        "type": "string"
                    }
                }
            },
            "Item": {
                "title": "Предмет",
                "required": [
                    "идентификатор",
                    "значение"
                ],
                "type": "object",
                "properties": {
                    "идентификатор": {
                        "title": "Идентификатор",
                        "type": "string"
                    },
                    "значение": {
                        "title": "Значение",
                        "type": "string"
                    }
                }
            },
            "ValidationError": {
                "title": "Ошибка валидации",
                "required": [
                    "местоположение",
                    "сообщение",
                    "тип"
                ],
                "type": "object",
                "properties": {
                    "местоположение": {
                        "title": "Location",
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    },
                    "сообщение": {
                        "title": "Сообщение",
                        "type": "string"
                    },
                    "тип": {
                        "title": "Тип ошибки",
                        "type": "string"
                    }
                }
            },
            "HTTPValidationError": {
                "title": "Ошибка валидации HTTP",
                "type": "object",
                "properties": {
                    "детали": {
                        "title": "Детали",
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/ValidationError"
                        }
                    }
                }
            }
        }
    }
}
```

## Дополнительные типы содержимого для основного ответа

Вы можете использовать этот же параметр `responses`, чтобы добавить разные типы содержимого для одного и того же основного ответа.

Например, вы можете добавить дополнительный медиа-тип `image/png`, объявив, что ваши *операции пути* могут возвращать JSON объект (с медиа-типом `application/json`) или изображение PNG:

{* ../../docs_src/additional_responses/tutorial002.py hl[19:24,28] *}

/// note | Заметка

Обратите внимание, что вы должны возвращать изображение, используя `FileResponse` напрямую.

///

/// info | Информация

Если вы явно не указываете другой тип содержимого в вашем параметре `responses`, FastAPI предположит, что ответ имеет тот же тип содержимого, что и основной класс ответа (по умолчанию `application/json`).

Но если вы задали пользовательский класс ответа с `None` в качестве типа содержимого, FastAPI будет использовать `application/json` для любого дополнительного ответа, у которого есть ассоциированная модель.

///

## Комбинирование информации

Вы также можете комбинировать информацию о ответах из разных мест, включая параметры `response_model`, `status_code` и `responses`.

Вы можете объявить `response_model`, используя стандартный статус-код `200` (или пользовательский, если необходимо), а затем объявить дополнительную информацию для этого же ответа в `responses`, напрямую в схеме OpenAPI.

**FastAPI** сохранит дополнительную информацию из `responses` и объединит ее с JSON Schema из вашей модели.

Например, вы можете объявить ответ с кодом состояния `404`, который использует Pydantic-модель и имеет пользовательское `description`.

И ответ с кодом состояния `200`, который использует ваш `response_model`, но включает пользовательский `example`:

{* ../../docs_src/additional_responses/tutorial003.py hl[20:31] *}

Все это будет объединено и включено в ваш OpenAPI, и показано в документации API:

<img src="/img/tutorial/additional-responses/image01.png">

## Комбинирование предопределенных и пользовательских ответов

Возможно, вы захотите иметь некоторые предопределенные ответы, которые применяются ко многим *операциям пути*, но хотите объединить их с пользовательскими ответами, необходимыми для каждой *операции пути*.

Для таких случаев вы можете использовать технику Python "распаковка" `dict` с помощью `**dict_to_unpack`:

```Python
old_dict = {
    "old key": "old value",
    "second old key": "second old value",
}
new_dict = {**old_dict, "new key": "new value"}
```

Здесь, `new_dict` будет содержать все пары `ключ-значение` из `old_dict` плюс новую пару `ключ-значение`:

```Python
{
    "old key": "old value",
    "second old key": "second old value",
    "new key": "new value",
}
```

Вы можете использовать эту технику для повторного использования некоторых предопределенных ответов в ваших *операциях пути* и объединить их с дополнительными пользовательскими.

Например:

{* ../../docs_src/additional_responses/tutorial004.py hl[13:17,26] *}

## Больше информации об ответах OpenAPI

Чтобы узнать, что именно можно включить в ответы, вы можете посмотреть эти разделы в спецификации OpenAPI:

* <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.1.0.md#responses-object" class="external-link" target="_blank">OpenAPI Responses Object</a>, включает в себя `Response Object`.
* <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.1.0.md#response-object" class="external-link" target="_blank">OpenAPI Response Object</a>, вы можете включить что угодно из этого напрямую в каждый ответ внутри вашего параметра `responses`. Включая `description`, `headers`, `content` (внутри этого вы указываете разные типы медиа и JSON Schemas), и `links`.
