# Пользовательский ответ - HTML, поток, файл и другие

По умолчанию **FastAPI** будет возвращать ответы, используя `JSONResponse`.

Вы можете переопределить это, возвращая `Response` напрямую, как показано в разделе [Возврат Response напрямую](response-directly.md){.internal-link target=_blank}.

Но если вы возвращаете `Response` напрямую (или любой подкласс, такой как `JSONResponse`), данные не будут автоматически конвертироваться (даже если вы объявите `response_model`), и документация не будет автоматически генерироваться (например, включая конкретный "тип содержимого", в HTTP-заголовке `Content-Type` как часть генерируемого OpenAPI).

Но вы также можете объявить `Response`, который хотите использовать (например, любой подкласс `Response`), в *декораторе операции пути*, используя параметр `response_class`.

Содержимое, которое вы возвращаете из вашей *функции-обработчика пути*, будет помещено внутрь этого `Response`.

И если этот `Response` имеет JSON тип содержимого (`application/json`), как в случае с `JSONResponse` и `UJSONResponse`, данные, которые вы возвращаете, будут автоматически конвертироваться (и фильтроваться) с помощью любого Pydantic `response_model`, который вы объявили в *декораторе операции пути*.

/// note | Замечание

Если вы используете класс ответа без типа содержимого, FastAPI ожидает, что ваш ответ не будет содержать контент, поэтому он не задокументирует формат ответа в автоматически генерируемой документации OpenAPI.

///

## Использование `ORJSONResponse`

Например, если вы заботитесь о производительности, вы можете установить и использовать <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a> и установить ответ `ORJSONResponse`.

Импортируйте класс (подкласс) `Response`, который вы хотите использовать, и объявите его в *декораторе операции пути*.

Для больших ответов возврат `Response` напрямую значительно быстрее, чем возврат словаря.

Это происходит потому, что по умолчанию FastAPI будет проверять каждый элемент внутри и убеждаться, что он сериализуем как JSON, используя тот же [Совместимый с JSON кодировщик](../tutorial/encoder.md){.internal-link target=_blank}, о котором рассказано в руководстве. Это позволяет вам возвращать **произвольные объекты**, например, модели базы данных.

Но если вы уверены, что содержимое, которое вы возвращаете, **сериализуемо с JSON**, вы можете передать его напрямую в класс ответа и избежать дополнительной нагрузки, которую FastAPI имел бы, передавая возвращаемый контент через `jsonable_encoder` перед передачей его в класс ответа.

{* ../../docs_src/custom_response/tutorial001b.py hl[2,7] *}

/// info | Информация

Параметр `response_class` также будет использоваться для определения "типа содержимого" ответа.

В данном случае HTTP-заголовок `Content-Type` будет установлен в `application/json`.

И он будет задокументирован как таковой в OpenAPI.

///

/// tip | Совет

`ORJSONResponse` доступен только в FastAPI, не в Starlette.

///

## HTML-ответ

Чтобы вернуть ответ с HTML напрямую из **FastAPI**, используйте `HTMLResponse`.

* Импортируйте `HTMLResponse`.
* Передайте `HTMLResponse` в качестве параметра `response_class` вашего *декоратора операции пути*.

{* ../../docs_src/custom_response/tutorial002.py hl[2,7] *}

/// info | Информация

Параметр `response_class` также будет использоваться для определения "типа содержимого" ответа.

В этом случае HTTP-заголовок `Content-Type` будет установлен в `text/html`.

И он будет задокументирован как таковой в OpenAPI.

///

### Возврат `Response`

Как показано в разделе [Возврат Response напрямую](response-directly.md){.internal-link target=_blank}, вы также можете переопределить ответ напрямую в вашей *операции пути*, возвращая его.

Тот же пример, что и выше, возвращающий `HTMLResponse`, может выглядеть так:

{* ../../docs_src/custom_response/tutorial003.py hl[2,7,19] *}

/// warning | Предупреждение

`Response`, возвращенный напрямую вашей *функцией-обработчиком пути*, не будет задокументирован в OpenAPI (например, `Content-Type` не будет задокументирован) и не будет виден в автоматически генерируемой интерактивной документации.

///

/// info | Информация

Конечно, фактический заголовок `Content-Type`, статус-код и др., будут из объекта `Response`, который вы вернули.

///

### Документирование в OpenAPI и переопределение `Response`

Если вы хотите переопределить ответ из функции, но при этом документация должна содержать "тип содержимого" в OpenAPI, вы можете использовать параметр `response_class` И вернуть объект `Response`.

Тогда `response_class` будет использоваться только для документирования OpenAPI *операции пути*, но ваш `Response` будет использоваться как есть.

#### Возврат `HTMLResponse` напрямую

Например, это может быть что-то вроде:

{* ../../docs_src/custom_response/tutorial004.py hl[7,21,23] *}

В этом примере функция `generate_html_response()` уже генерирует и возвращает `Response` вместо возврата HTML в виде `str`.

Возвращая результат вызова `generate_html_response()`, вы уже возвращаете `Response`, который переопределит поведение **FastAPI** по умолчанию.

Но так как вы также передали `HTMLResponse` в `response_class`, **FastAPI** будет знать, как задокументировать это в OpenAPI и интерактивной документации как HTML с `text/html`:

<img src="/img/tutorial/custom-response/image01.png">

## Доступные ответы

Вот некоторые из доступных ответов.

Имейте в виду, что вы можете использовать `Response` для возврата чего-либо еще или даже создать собственный подкласс.

/// note | Технические детали

Вы также можете использовать `from starlette.responses import HTMLResponse`.

**FastAPI** предоставляет те же `starlette.responses`, что и `fastapi.responses`, просто для вашего удобства, как разработчика. Но большинство доступных ответов поступают напрямую из Starlette.

///

### `Response`

Основной класс `Response`, все остальные ответы наследуются от него.

Вы можете вернуть его напрямую.

Он принимает следующие параметры:

* `content` - `str` или `bytes`.
* `status_code` - `int` HTTP статус-код.
* `headers` - `dict` строк.
* `media_type` - `str`, который задает тип содержимого, например `"text/html"`.

FastAPI (фактически Starlette) автоматически добавит заголовок Content-Length. Он также включит заголовок Content-Type, основанный на `media_type` и добавит кодировку для текстовых типов.

{* ../../docs_src/response_directly/tutorial002.py hl[1,18] *}

### `HTMLResponse`

Принимает текст или байты и возвращает HTML-ответ, как вы прочли выше.

### `PlainTextResponse`

Принимает текст или байты и возвращает ответ с простым текстом.

{* ../../docs_src/custom_response/tutorial005.py hl[2,7,9] *}

### `JSONResponse`

Принимает данные и возвращает ответ, кодированный как `application/json`.

Это ответ по умолчанию, используемый в **FastAPI**, как вы прочли выше.

### `ORJSONResponse`

Быстрая альтернатива JSON-ответа, использующая <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a>, как вы прочли выше.

/// info | Информация

Для этого требуется установка `orjson`, например с помощью `pip install orjson`.

///

### `UJSONResponse`

Альтернативный JSON-ответ, использующий <a href="https://github.com/ultrajson/ultrajson" class="external-link" target="_blank">`ujson`</a>.

/// info | Информация

Для этого требуется установка `ujson`, например с помощью `pip install ujson`.

///

/// warning | Предупреждение

`ujson` менее осторожна, чем встроенная реализация Python, в том, как она обрабатывает некоторые крайние случаи.

///

{* ../../docs_src/custom_response/tutorial001.py hl[2,7] *}

/// tip | Совет

Возможно, `ORJSONResponse` может быть более быстрой альтернативой.

///

### `RedirectResponse`

Возвращает HTTP-перенаправление. Использует статус-код 307 (Временное перенаправление) по умолчанию.

Вы можете вернуть `RedirectResponse` напрямую:

{* ../../docs_src/custom_response/tutorial006.py hl[2,9] *}

---

Или вы можете использовать его в параметре `response_class`:


{* ../../docs_src/custom_response/tutorial006b.py hl[2,7,9] *}

Если вы сделаете это, то можете вернуть URL непосредственно из вашей *функции-обработчика пути*.

В этом случае, используемый `status_code` будет тем, что по умолчанию для `RedirectResponse`, а именно `307`.

---

Вы также можете использовать параметр `status_code` в сочетании с параметром `response_class`:

{* ../../docs_src/custom_response/tutorial006c.py hl[2,7,9] *}

### `StreamingResponse`

Принимает асинхронный генератор или обычный генератор/итератор и отправляет тело ответа в потоке.

{* ../../docs_src/custom_response/tutorial007.py hl[2,14] *}

#### Использование `StreamingResponse` с объектами, похожими на файлы

Если у вас есть объект, похожий на файл (например, объект, возвращаемый `open()`), вы можете создать функцию-генератор для итерации по этому объекту.

Таким образом, вам не нужно предварительно загружать все в память, и вы можете передать эту функцию-генератор в `StreamingResponse` и вернуть ее.

Это включает множество библиотек для взаимодействия с облачным хранилищем, обработки видео и других.

{* ../../docs_src/custom_response/tutorial008.py hl[2,10:12,14] *}

1. Это функция-генератор. Это "функция-генератор", потому что она содержит оператор `yield`.
2. Используя блок `with`, мы обеспечиваем закрытие объекта, похожего на файл, после завершения выполнения функции-генератора. То есть после того, как отправка ответа завершена.
3. Этот `yield from` указывает функции итерироваться по объекту `file_like`. Затем для каждой части, которую итерация проходит, возвращать эту часть из функции-генератора (`iterfile`).

    Таким образом, это функция-генератор, которая передает работу по "генерации" чему-то еще во внутренности.

    Делая так, мы можем поместить это в блок `with` и таким образом обеспечить закрытие объекта, похожего на файл, после завершения.

/// tip | Совет

Обратите внимание, что здесь, так как мы используем стандартный `open()`, который не поддерживает `async` и `await`, мы объявляем операцию пути с использованием обычного `def`.

///

### `FileResponse`

Асинхронно отправляет файл в поток как ответ.

Принимает другой набор аргументов для создания экземпляра, чем другие типы ответов:

* `path` - Путь к файлу, который необходимо отправить в поток.
* `headers` - Любые пользовательские заголовки, которые необходимо включить, в виде словаря.
* `media_type` - Строка, задающая тип содержимого. Если не установлено, для определения типа содержимого будет использоваться имя файла или путь.
* `filename` - Если установлено, это будет включено в заголовок `Content-Disposition` ответа.

Ответы на файлы будут включать соответствующие заголовки `Content-Length`, `Last-Modified` и `ETag`.

{* ../../docs_src/custom_response/tutorial009.py hl[2,10] *}

Вы также можете использовать параметр `response_class`:

{* ../../docs_src/custom_response/tutorial009b.py hl[2,8,10] *}

В этом случае, вы можете вернуть путь к файлу напрямую из вашей *функции-обработчика пути*.

## Класс пользовательского ответа

Вы можете создать свой собственный класс пользовательского ответа, наследуя от `Response` и используя его.

Например, предположим, вы хотите использовать <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a>, но с некоторыми пользовательскими настройками, не используемыми в включенном классе `ORJSONResponse`.

Допустим, вы хотите, чтобы он возвращал JSON с отступами и форматированием, поэтому вы хотите использовать опцию orjson `orjson.OPT_INDENT_2`.

Вы могли бы создать `CustomORJSONResponse`. Главное, что вам нужно сделать, это создать метод `Response.render(content)`, который возвращает содержимое как `bytes`:

{* ../../docs_src/custom_response/tutorial009c.py hl[9:14,17] *}

Теперь вместо возвращения:

```json
{"message": "Hello World"}
```

...этот ответ вернет:

```json
{
  "message": "Hello World"
}
```

Конечно, вы, вероятно, найдете гораздо лучшие способы использовать это, чем форматирование JSON. 😉

## Класс ответа по умолчанию

При создании экземпляра класса **FastAPI** или `APIRouter` вы можете указать, какой класс ответа использовать по умолчанию.

Параметр, который это определяет, называется `default_response_class`.

В приведенном ниже примере **FastAPI** будет использовать `ORJSONResponse` по умолчанию во всех *операциях пути* вместо `JSONResponse`.

{* ../../docs_src/custom_response/tutorial010.py hl[2,4] *}

/// tip | Совет

Вы все еще можете переопределять `response_class` в *операциях пути*, как и раньше.

///

## Дополнительная документация

Вы также можете объявить тип содержимого и многие другие детали в OpenAPI, используя `responses`: [Дополнительные ответы в OpenAPI](additional-responses.md){.internal-link target=_blank}.
