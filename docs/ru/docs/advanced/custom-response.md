# Пользовательский ответ - HTML, поток, файл и другие

По умолчанию, **FastAPI** будет возвращать ответы, используя `JSONResponse`.

Вы можете переопределить это, возвращая `Response` напрямую, как показано в [Возврат ответа напрямую](response-directly.md){.internal-link target=_blank}.

Но если вы возвращаете `Response` напрямую (или любой подкласс, например, `JSONResponse`), данные не будут автоматически преобразованы (даже если вы объявите `response_model`), и документация не будет автоматически сгенерирована (например, включая конкретный "media type", в HTTP заголовке `Content-Type` как часть сгенерированного OpenAPI).

Но вы также можете объявить `Response`, который вы хотите использовать (например, любой подкласс `Response`), в *декораторе операции пути* с использованием параметра `response_class`.

Содержание, которое вы возвращаете из вашей *функции операции пути*, будет помещено внутрь этого `Response`.

И если этот `Response` имеет тип носителя JSON (`application/json`), как в случае с `JSONResponse` и `UJSONResponse`, данные, которые вы возвращаете, будут автоматически преобразованы (и отфильтрованы) с любым Pydantic `response_model`, который вы объявили в *декораторе операции пути*.

/// note | Заметка

Если вы используете класс ответа без типа носителя, FastAPI ожидает, что ваш ответ будет без содержимого, поэтому формат ответа не будет задокументирован в сгенерированных OpenAPI документах.

///

## Используйте `ORJSONResponse`

Например, если вы хотите повысить производительность, вы можете установить и использовать <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a> и установить ответ в `ORJSONResponse`.

Импортируйте класс `Response` (подкласс), который вы хотите использовать, и объявите его в *декораторе операции пути*.

Для больших ответов возврат `Response` напрямую значительно быстрее, чем возврат словаря.

Это потому, что по умолчанию, FastAPI будет проверять каждый элемент внутри и удостоверяться, что он сериализуем в JSON, используя тот же [Совместимый с JSON кодировщик](../tutorial/encoder.md){.internal-link target=_blank}, описанный в тутореале. Это то, что позволяет вам возвращать **произвольные объекты**, например, модели базы данных.

Но если вы уверены, что содержание, которое вы возвращаете, **сериализуемо в JSON**, вы можете передать его напрямую в класс ответов и избежать дополнительной нагрузки, которая возникла бы у FastAPI, пропуская ваше возвращаемое содержимое через `jsonable_encoder` перед передачей его в класс ответов.

{* ../../docs_src/custom_response/tutorial001b.py hl[2,7] *}

/// info | Информация

Параметр `response_class` также будет использоваться для определения "media type" ответа.

В этом случае, HTTP заголовок `Content-Type` будет установлен в `application/json`.

И он будет задокументирован как таковой в OpenAPI.

///

/// tip | Совет

`ORJSONResponse` доступен только в FastAPI, он недоступен в Starlette.

///

## HTML Ответ

Чтобы вернуть ответ с HTML напрямую из **FastAPI**, используйте `HTMLResponse`.

* Импортируйте `HTMLResponse`.
* Передайте `HTMLResponse` как параметр `response_class` вашего *декоратора операции пути*.

{* ../../docs_src/custom_response/tutorial002.py hl[2,7] *}

/// info | Информация

Параметр `response_class` также будет использоваться для определения "media type" ответа.

В этом случае, HTTP заголовок `Content-Type` будет установлен в `text/html`.

И он будет задокументирован как таковой в OpenAPI.

///

### Возврат `Response`

Как показано в [Возврат ответа напрямую](response-directly.md){.internal-link target=_blank}, вы также можете переопределить ответ напрямую в вашей *операции пути*, возвращая его.

Тот же самый пример, возвращающий `HTMLResponse`, мог бы выглядеть следующим образом:

{* ../../docs_src/custom_response/tutorial003.py hl[2,7,19] *}

/// warning | Предупреждение

`Response`, возвращенный напрямую вашей *функцией операции пути*, не будет задокументирован в OpenAPI (например, `Content-Type` не будет документирован) и не будет виден в автоматической интерактивной документации.

///

/// info | Информация

Конечно, фактический заголовок `Content-Type`, код статуса и т.д. будут исходить из объекта `Response`, который вы вернули.

///

### Документирование в OpenAPI и переопределение `Response`

Если вы хотите переопределить ответ внутри функции, но в то же время задокументировать "media type" в OpenAPI, вы можете использовать параметр `response_class` И вернуть объект `Response`.

`response_class` будет использоваться только для документирования *операции пути* в OpenAPI, но ваш `Response` будет использоваться как есть.

#### Возврат `HTMLResponse` напрямую

Например, это может выглядеть следующим образом:

{* ../../docs_src/custom_response/tutorial004.py hl[7,21,23] *}

В этом примере функция `generate_html_response()` уже генерирует и возвращает `Response` вместо возврата HTML в `str`.

Возвращая результат вызова `generate_html_response()`, вы уже возвращаете `Response`, который переопределяет стандартное поведение **FastAPI**.

Но, поскольку вы также передали `HTMLResponse` в `response_class`, **FastAPI** будет знать, как задокументировать это в OpenAPI и интерактивной документации, как HTML с `text/html`:

<img src="/img/tutorial/custom-response/image01.png">

## Доступные ответы

Вот некоторые из доступных ответов.

Имейте в виду, что вы можете использовать `Response`, чтобы вернуть что-либо еще, или даже создать собственный подкласс.

/// note | Технические подробности

Вы также могли бы использовать `from starlette.responses import HTMLResponse`.

**FastAPI** предоставляет тот же `starlette.responses` как `fastapi.responses` просто для вашего удобства как разработчика. Но большинство доступных ответов поступают непосредственно из Starlette.

///

### `Response`

Основной класс `Response`, все другие ответы наследуются от него.

Вы можете вернуть его напрямую.

Он принимает следующие параметры:

* `content` - `str` или `bytes`.
* `status_code` - `int` HTTP код состояния.
* `headers` - `dict` строк.
* `media_type` - `str`, указывающая тип носителя. Например, `"text/html"`.

FastAPI (фактически Starlette) автоматически включит заголовок Content-Length. Также будет включен заголовок Content-Type, основанный на `media_type` и добавлением кодировки для текстовых типов.

{* ../../docs_src/response_directly/tutorial002.py hl[1,18] *}

### `HTMLResponse`

Принимает некоторый текст или байты и возвращает HTML ответ, как вы прочли выше.

### `PlainTextResponse`

Принимает некоторый текст или байты и возвращает ответ с простым текстом.

{* ../../docs_src/custom_response/tutorial005.py hl[2,7,9] *}

### `JSONResponse`

Принимает некоторые данные и возвращает закодированный ответ `application/json`.

Это стандартный ответ, используемый в **FastAPI**, как вы прочли выше.

### `ORJSONResponse`

Быстрая альтернатива JSON ответу, используя <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a>, как вы прочли выше.

/// info | Информация

Это требует установки `orjson`, например с `pip install orjson`.

///

### `UJSONResponse`

Альтернативный JSON ответ, используя <a href="https://github.com/ultrajson/ultrajson" class="external-link" target="_blank">`ujson`</a>.

/// info | Информация

Это требует установки `ujson`, например с `pip install ujson`.

///

/// warning | Предупреждение

`ujson` менее аккуратен по сравнению с встроенной реализацией Python в том, как он обрабатывает некоторые крайние случаи.

///

{* ../../docs_src/custom_response/tutorial001.py hl[2,7] *}

/// tip | Совет

Возможно, `ORJSONResponse` может оказаться более быстрой альтернативой.

///

### `RedirectResponse`

Возвращает HTTP переадресацию. Использует код состояния 307 (Временная переадресация) по умолчанию.

Вы можете вернуть `RedirectResponse` напрямую:

{* ../../docs_src/custom_response/tutorial006.py hl[2,9] *}

---

Или вы можете использовать его в параметре `response_class`:

{* ../../docs_src/custom_response/tutorial006b.py hl[2,7,9] *}

Если вы сделаете это, тогда вы можете вернуть URL напрямую из вашей *функции операции пути*.

В этом случае, используемый `status_code` будет таким же, как стандартный для `RedirectResponse`, который равен `307`.

---

Вы также можете использовать параметр `status_code`, комбинируя его с параметром `response_class`:

{* ../../docs_src/custom_response/tutorial006c.py hl[2,7,9] *}

### `StreamingResponse`

Принимает асинхронный генератор или обычный генератор/итератор и потоково передает тело ответа.

{* ../../docs_src/custom_response/tutorial007.py hl[2,14] *}

#### Использование `StreamingResponse` с объектами подобными файлам

Если у вас есть объект подобный файлу (например, объект, возвращаемый `open()`), вы можете создать функцию-генератор для итерации по этому объекту подобному файлу.

Таким образом, вам не придется предварительно полностью загружать его в память, и вы можете передать эту функцию-генератор в `StreamingResponse` и вернуть его.

Это включает многие библиотеки для работы с облачным хранилищем, обработки видео и другие.

{* ../../docs_src/custom_response/tutorial008.py hl[2,10:12,14] *}

1. Это функция-генератор. Это "функция-генератор", потому что внутри содержит `yield` операторы.
2. Используя `with` блок, мы удостоверяемся, что объект подобный файлу закрыт после завершения работы функции-генератора. То есть, после завершения отправки ответа.
3. Этот `yield from` указывает функции итерироваться по объекту `file_like`. А затем, для каждой части итерации, выдавать эту часть как идущую из этой функции-генератора (`iterfile`).

    Таким образом, это функция-генератор, которая передает работу по "генерации" чему-то еще внутри себя.

    Делая это таким образом, мы можем поместить это в `with` блок и, таким образом, удостовериться, что объект подобный файлу закрыт после завершения.

/// tip | Совет

Обратите внимание, что здесь, так как мы используем стандартный `open()`, который не поддерживает `async` и `await`, мы объявляем операцию пути с помощью обычной `def`.

///

### `FileResponse`

Асинхронно потоком передает файл в качестве ответа.

Принимает другой набор аргументов для инстанцирования по сравнению с другими типами ответов:

* `path` - Путь к файлу для потоковой передачи.
* `headers` - Любые пользовательские заголовки для включения, как словарь.
* `media_type` - Строка, указывающая тип носителя. Если не указан, имя файла или путь будут использованы для определения типа носителя.
* `filename` - Если установлен, это будет включено в ответ `Content-Disposition`.

Ответы с файлами будут включать соответствующие заголовки `Content-Length`, `Last-Modified` и `ETag`.

{* ../../docs_src/custom_response/tutorial009.py hl[2,10] *}

Вы также можете использовать параметр `response_class`:

{* ../../docs_src/custom_response/tutorial009b.py hl[2,8,10] *}

В этом случае вы можете вернуть путь к файлу напрямую из вашей *функции операции пути*.

## Пользовательский класс ответа

Вы можете создать собственный пользовательский класс ответа, наследуясь от `Response` и используя его.

Например, давайте скажем, что вы хотите использовать <a href="https://github.com/ijl/orjson" class="external-link" target="_blank">`orjson`</a>, но с некоторыми пользовательскими настройками, которые не используются в включенном классе `ORJSONResponse`.

Давайте скажем, вы хотите, чтобы он возвращал отформатированный и с отступами JSON, поэтому вы хотите использовать опцию orjson `orjson.OPT_INDENT_2`.

Вы могли бы создать `CustomORJSONResponse`. Основное, что вам нужно сделать, это создать метод `Response.render(content)`, который возвращает содержимое в виде `bytes`:

{* ../../docs_src/custom_response/tutorial009c.py hl[9:14,17] *}

Теперь вместо возврата:

```json
{"message": "Hello World"}
```

...этот ответ будет возвращать:

```json
{
  "message": "Hello World"
}
```

Конечно, вы, вероятно, найдете гораздо лучшие способы использовать это, чем просто форматирование JSON. 😉

## Класс ответа по умолчанию

При создании экземпляра класса **FastAPI** или `APIRouter` вы можете указать, какой класс ответа использовать по умолчанию.

Параметр, который определяет это — `default_response_class`.

В примере ниже, **FastAPI** будет использовать `ORJSONResponse` по умолчанию, во всех *операциях пути*, вместо `JSONResponse`.

{* ../../docs_src/custom_response/tutorial010.py hl[2,4] *}

/// tip | Совет

Вы все равно можете переопределить `response_class` в *операциях пути* как прежде.

///

## Дополнительная документация

Вы также можете объявить тип носителя и многие другие детали в OpenAPI, используя `responses`: [Дополнительные ответы в OpenAPI](additional-responses.md){.internal-link target=_blank}.
