# OpenAPI Callbacks

Вы можете создать API с *операцией пути*, которая может инициировать запрос к *внешнему API*, созданному кем-то другим (вероятно, тем же разработчиком, который будет *использовать* ваше API).

Процесс, который происходит, когда ваше API-приложение вызывает *внешний API*, называется "callback". Потому что ПО, написанное внешним разработчиком, отправляет запрос вашему API, а затем ваше API *отвечает*, отправляя запрос к *внешнему API* (который, возможно, был создан тем же разработчиком).

В этом случае, вы могли бы захотеть задокументировать, как этот внешний API *должен* выглядеть. Какие *операции пути* он должен содержать, какое тело ожидать, какой ответ должен возвращать и т.д.

## Приложение с callback'ами

Рассмотрим это на примере.

Представьте, что вы разрабатываете приложение, позволяющее создавать счета.

Эти счета будут иметь `id`, `title` (опционально), `customer` и `total`.

Пользователь вашего API (внешний разработчик) создаст счет в вашем API с помощью POST-запроса.

Затем ваше API будет (давайте представим):

* Отправлять счет какому-то клиенту внешнего разработчика.
* Собирать деньги.
* Отправлять уведомление обратно пользователю API (внешнему разработчику).
    * Это будет сделано с помощью отправки POST-запроса (от *вашего API*) в некоторый *внешний API*, предоставленный этим внешним разработчиком (это и есть "callback").

## Обычное приложение **FastAPI**

Сначала посмотрим, как обычное приложение API выглядело бы до добавления callback'а.

Оно будет иметь *операцию пути*, которая будет принимать `Invoice` в теле запроса и параметр запроса `callback_url`, который будет содержать URL для callback'а.

Эта часть довольно обычная, и, вероятно, большая часть кода уже знакома вам:

{* ../../docs_src/openapi_callbacks/tutorial001.py hl[9:13,36:53] *}

/// tip | Подсказка

Параметр запроса `callback_url` использует тип Url из Pydantic <a href="https://docs.pydantic.dev/latest/api/networks/" class="external-link" target="_blank">Url</a>.

///

Единственное новое здесь — это `callbacks=invoices_callback_router.routes` как аргумент к *декоратору операции пути*. Дальше мы увидим, что это значит.

## Документирование callback'а

Фактический код callback'а будет сильно зависеть от вашего API-приложения.

И, вероятно, значительно изменится от одного приложения к другому.

Это может быть всего одна или две строчки кода, такие как:

```Python
callback_url = "https://example.com/api/v1/invoices/events/"
httpx.post(callback_url, json={"description": "Invoice paid", "paid": True})
```

Но, возможно, наиболее важная часть callback'а — это убедиться, что пользователь вашего API (внешний разработчик) корректно реализует *внешний API*, согласно данным, которые *ваше API* собирается отправить в теле запроса callback'а и т.д.

Итак, следующее, что мы сделаем, это добавим код для документации, как этот *внешний API* должен выглядеть для получения callback'а от *вашего API*.

Эта документация отобразится в интерфейсе Swagger по адресу `/docs` в вашем API и позволит внешним разработчикам узнать, как создать *внешний API*.

Этот пример не реализует сам callback (это может быть всего одна строка кода), только часть документации.

/// tip | Подсказка

Фактический callback — это просто HTTP-запрос.

При реализации callback'а самостоятельно, вы можете использовать что-то вроде <a href="https://www.python-httpx.org" class="external-link" target="_blank">HTTPX</a> или <a href="https://requests.readthedocs.io/" class="external-link" target="_blank">Requests</a>.

///

## Написание кода документации для callback'а

Этот код не будет выполнен в вашем приложении, нам нужно его только чтобы *документировать*, как *внешний API* должен выглядеть.

Но вы уже знаете, как легко создавать автоматическую документацию для API с **FastAPI**.

Поэтому мы используем эти же знания, чтобы задокументировать, как *внешний API* должен выглядеть... создавая *операцию(ии) пути*, которые внешний API должен реализовать (те, которые ваше API вызовет).

/// tip | Подсказка

Когда пишете код для документации callback'а, может быть полезно представить, что вы — этот *внешний разработчик*. И что вы в данный момент реализуете *внешний API*, а не *ваше API*.

Временное принятие этой точки зрения (внешнего разработчика) поможет вам скорее определить, куда помещать параметры, Pydantic-модель для тела запроса, для ответа и т.д. для этого *внешнего API*.

///

### Создание callback `APIRouter`

Сначала создайте новый `APIRouter`, который будет содержать один или несколько callback'ов.

{* ../../docs_src/openapi_callbacks/tutorial001.py hl[3,25] *}

### Создание callback *операции пути*

Чтобы создать callback *операцию пути*, используйте тот же `APIRouter`, который вы создали выше.

Она должна выглядеть как обычная операция пути FastAPI:

* Она, вероятно, должна иметь объявление тела запроса, которое она должна принять, например `body: InvoiceEvent`.
* И она может также иметь объявление ответа, который она должна вернуть, например `response_model=InvoiceEventReceived`.

{* ../../docs_src/openapi_callbacks/tutorial001.py hl[16:18,21:22,28:32] *}

Есть 2 основных отличия от обычной *операции пути*:

* Реальный код не нужен, так как ваше приложение никогда не вызовет этот код. Он используется только для документирования *внешнего API*. Поэтому функция может просто содержать `pass`.
* В *пути* может содержаться <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.1.0.md#key-expression" class="external-link" target="_blank">выражение OpenAPI 3</a> (подробнее ниже), где можно использовать переменные с параметрами и частями оригинального запроса, отправленного к *вашему API*.

### Выражение пути callback'а

Путь callback'а может содержать <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.1.0.md#key-expression" class="external-link" target="_blank">выражение OpenAPI 3</a>, которое может включать части оригинального запроса, отправленного к *вашему API*.

В этом случае это `str`:

```Python
"{$callback_url}/invoices/{$request.body.id}"
```

Таким образом, если пользователь вашего API (внешний разработчик) отправляет запрос к *вашему API* по адресу:

```
https://yourapi.com/invoices/?callback_url=https://www.external.org/events
```

с JSON-телом:

```JSON
{
    "id": "2expen51ve",
    "customer": "Mr. Richie Rich",
    "total": "9999"
}
```

тогда *ваше API* обработает счет, и чуть позже отправит callback-запрос на `callback_url` (во *внешний API*):

```
https://www.external.org/events/invoices/2expen51ve
```

с JSON-телом, содержащим что-то вроде:

```JSON
{
    "description": "Payment celebration",
    "paid": true
}
```

и ожидает ответа от этого *внешнего API* с JSON-телом вроде:

```JSON
{
    "ok": true
}
```

/// tip | Подсказка

Обратите внимание, как callback URL включает URL, полученный как параметр запроса в `callback_url` (`https://www.external.org/events`), и также `id` счета из тела JSON (`2expen51ve`).

///

### Добавление router для callback'ов

На данном этапе у вас есть *операция(ии) пути для callback'а*, необходимые (те, которые *внешний разработчик* должен реализовать во *внешнем API*) в callback router, который вы создали выше.

Теперь используйте параметр `callbacks` в *декораторе операции пути вашего API*, чтобы передать атрибут `.routes` (который на самом деле является просто `list`'ом маршрутов/*операций пути*) из этого callback router:

{* ../../docs_src/openapi_callbacks/tutorial001.py hl[35] *}

/// tip | Подсказка

Обратите внимание, что вы не передаете сам router (`invoices_callback_router`) в `callback=`, а передаете атрибут `.routes`, как в `invoices_callback_router.routes`.

///

### Проверка документации

Теперь вы можете запустить ваше приложение и перейти на <a href="http://127.0.0.1:8000/docs" class="external-link" target="_blank">http://127.0.0.1:8000/docs</a>.

Вы увидите вашу документацию, включая раздел "Callbacks" для вашей *операции пути*, который показывает, как должен выглядеть *внешний API*:

<img src="/img/tutorial/openapi-callbacks/image01.png">
